#!/usr/bin/python

import string, sys, getopt, os, ConfigParser

HOME = os.path.expanduser("~")
PATH = HOME + "/.sire/"
CONFIG = PATH + "/sirerc"
DB = PATH + "/siredb"

NAME = "sire"
VERSION = "0.1.2"
AUTHORS = "Oscar Eriksson"
EMAIL = "(oscar.eriks@gmail.com)"
LICENCE = '''License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.'''

C = { 
    'default' : "\033[0m",
    'bold'    : "\033[1m",
    'red'     : "\033[31m",
    'green'   : "\033[32m",
    'yellow'  : "\033[33m",
    'blue'    : "\033[34m",
    'magenta' : "\033[35m",
    'cyan'    : "\033[36m",
}

# Define arguemnts.
opts, args = getopt.getopt(
    sys.argv[1:], # Arguements from commandline.
    'lhva:d:c:',  # Short arguments.
    ['list', 'add=', 'change=', 'delete=', 'help', 'version'] # Long arguments.
)

def usage():
    print '''Usage: [OPTION] [ARGUMENTS]
    --list, -l          Takes one argument, may be 'all', 'titles', a valid 
			catagory name, or defcat-list if omitted.
    --add, -a           Takes one or two arguments, first is the catagory, 
			second is the title, or defcat-add if omitted.
    --delete, -d        Takes one argument, which is the ID of the item to be 
			deleted.
    --change, -c        Takes one or two arguments, first is ID of the item and
			second is what catagory to change to, or defcat-change 
			if omitted.
    --help, -h          Prints this message.
    --version, -v       Prints version, author, email, licence.

    If no option or argument is specified, sire will list 'defcat-list' 
    specified in 'sirerc'.

For examples, see README.

Files:
    Configuration:
    ~/.sire/sirerc

    Database:
    ~/.sire/siredb
'''

# Prints version number, licence and authors with email.
def version():
    print NAME,VERSION,'\n',LICENCE,'\n\nWritten by: ',AUTHORS,EMAIL

def parseconfig(conffile):
    _config = {}
    cp = ConfigParser.ConfigParser()
    cp.read(conffile)
    for sec in cp.sections():
        name = string.lower(sec)
        for opt in cp.options(sec):
            _config[name + "." + string.lower(opt)] = string.strip(cp.get(sec, opt))
    return _config

# Print a catagory (status) description using bold and colors.
def printcatagory(catagory, config):
    if ("catagories." + catagory) not in config.keys():
        print "There is no Catagory description for catagory '" + catagory + "'!"
        sys.exit(1)

    if not ("colors." + catagory) in config.keys():
        if not "colors.defcol" in config.keys():
            color = ''

        else:
            color = C[config["colors.defcol"]]
    else:
        color = C[config["colors." + catagory]]

    print C["bold"], color, config["catagories." + catagory], "('" + catagory + "')", C["default"]

# Read the database.
# FIXME: I don't want to load a 500MB file each time I wan't to check what I can watch.
def parsedb(dbfile):
    db = {}
    id = 0
    f = file(dbfile, 'r')
    for line in f.readlines():
        parts = line.split(":", 2)
        parts[2] = parts[2][:-1]

        if not db.has_key(parts[0]):
            db[parts[0]] = {parts[1] : parts[2]}

        else:
            db[parts[0]][parts[1]] = parts[2]

        id += 1

    f.close()
    return db

# List either all catagories or only the default catagory.
def list(db, config, catagory):
    # Nothing in database.
    if db == {}:
        print "Empty."
        sys.exit()

    # Only print the catagory titles.
    if catagory == "titles":
        for title in db.keys():
            printcatagory(title, config)

        sys.exit()

    if   catagory == "all" : dbs = db.keys()
    elif catagory == None  : dbs = config["catagories.defcat-list"]
    else                   : dbs = [catagory]

    for catagory in dbs:
        if catagory not in db.keys():
            print "Empty catagory."
            sys.exit(1)

        dbsel = db[catagory].items()

        # Sorting is optional.
        if ("sort." + catagory) in config.keys():
            sortmethod = config["sort." + catagory]

        elif "sort.defsrt" in config.keys():
            sortmethod = config["sort.defsrt"]

        else:
            sortmethod = False

        if sortmethod is not False:
            # Sort by specified method.
            if   sortmethod == "title" : dbsel = sorted(db[catagory].items(), key=lambda (k,v): (v,k))
            elif sortmethod == "id"    : dbsel = sorted(db[catagory].items(), key=lambda (k,v): (int(k),v))
            else                       : dbsel = db[catagory].items()

        printcatagory(catagory, config)
        for id, title in dbsel:
            # Make titles aligned.
            spacer = ''
            for i in range(0, 3 - len(id)):
                spacer += ' '

            # Showing ID when listing is optional.
            if "general.showid" not in config.keys():
                print title
            
            elif config["general.showid"] == '1':
                print C['bold'] + id + spacer + C['default'], ':', title

            else:
                print title
 
        # For newline separator between items of different statuses.
        print

# Add an item to the database.
def add(db, config, name, catagory):
    if ("catagories." + catagory) not in config.keys():
        print "Specified catagory does not exist."
        sys.exit(1)

    l = []
    for k, v in db.iteritems():
        l += v.keys()

    id = "0"
    for i in l:
        if int(i) > int(id):
            id = str(i)

    id = str(int(id) + 1)

    f = open(DB, 'a')
    f.write(catagory + ":" + id + ":" + name + '\n')
    f.close()

    print "Saved '" + name + "' with id '" + id + "'."

# Delete an item from the database.
def delete(db, id):
    for d in db:
        if db[d].has_key(id):
            del db[d][id]

    savedb(db)
    print "Deleted item with ID '" + id + "'."

# Save a changed database.
def savedb(db):
    f = open(DB, 'w')
    for d in db:
        for id in db[d]:
            f.write(d + ":" + id + ":" + db[d][id] + "\n")

    f.close()

# Change the status of an item with ID 'id'.
def change(db, conf, id, newcat):
    found = False
    for d in db:
        if id in db[d].keys():
            found = True
            break;

    if not found:
        print "no no"
        sys.exit(1)

    if not ("catagories." + newcat) in conf.keys():
        print "No such catagory ('" + newcat + "'). Add it in the sirerc first."
        sys.exit(1)

    title = db[d][id]
    db[newcat][id] = title
    del db[d][id]

    print "Changed catagory of title with ID '" + id + "' from catagory '" + d + "' to catagory '" + newcat + "'."

    savedb(db)

# Handle command line arguments.
def main():
    # Check if config and database files exists and are read- and writeable.
    if not os.path.exists(DB) or not os.path.exists(CONFIG):
        print "Database and/or config file not found. Should be in ~/.sire/!"
        sys.exit(1)

    # First read the database from the file.
    db = parsedb(DB)

    # Read the config file.
    config = parseconfig(CONFIG)

    # If no argument given, list items of default catagory.
    if len(sys.argv) == 1:
        list(db, config, None)
        sys.exit()

    # What to do with the different arguments.
    for o, a in opts:
        if o in ("-h", "--help"):
            usage()
            sys.exit()

        elif o in ("-l", "--list"):
            if len(sys.argv) == 2:
                # Use default catagory first.
                catagory = config["catagories.defcat-list"]
                list(db, config, catagory)
                sys.exit()

            catagory = sys.argv[2]
            list(db, config, catagory)

        elif o in ("-a", "--add"):
            if len(sys.argv) < 3:
                usage()
                sys.exit(1)

            # Use default catagory first.
            catagory = config["catagories.defcat-add"]

            if len(sys.argv) == 4:
                catagory = sys.argv[3]

            title = sys.argv[2]
            add(db, config, title, catagory)

        elif o in ("-d", "--delete"):
            if len(sys.argv) < 3:
                usage()
                sys.exit(1)
    
            id = sys.argv[2]
            delete(db, id)

        elif o in ("-c", "--change"):
            if len(sys.argv) < 3:
                usage()
                sys.exit(1)
    
            id = sys.argv[2]

            # Use default catagory first.
            catagory = config["catagories.defcat-change"]

            if len(sys.argv) == 4:
                catagory = sys.argv[3]

            change(db, config, id, catagory)

        elif o in ("-v", "--version"):
            version()
            exit()

        else:
            usage()
            exit(1)

# Call main().
if __name__ == "__main__":
    main()
    sys.exit()
